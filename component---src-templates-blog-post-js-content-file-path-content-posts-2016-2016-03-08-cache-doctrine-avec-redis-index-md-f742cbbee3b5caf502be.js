"use strict";(self.webpackChunkmaxpou_fr=self.webpackChunkmaxpou_fr||[]).push([[5981],{7189:function(n,e,a){a.r(e),a.d(e,{default:function(){return g}});var s=a(1151),t=a(7294);function l(n){const e=Object.assign({blockquote:"blockquote",p:"p",strong:"strong",span:"span",a:"a",ul:"ul",li:"li",em:"em",h2:"h2",br:"br"},(0,s.ah)(),n.components);return t.createElement(t.Fragment,null,t.createElement(e.blockquote,null,"\n",t.createElement(e.p,null,"La meilleur requête est celle que l’on a pas à faire — ",t.createElement(e.strong,null,"un inconnu")),"\n"),"\n",t.createElement(e.p,null,"Dans mon actuelle mission, nous développons une application sous Symfony2 avec Doctrine comme ORM.\nVoici grossièrement à quoi ressemble l’architecture globale :"),"\n",t.createElement(e.span,{dangerouslySetInnerHTML:{__html:'<span\n      class="gatsby-resp-image-wrapper"\n      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; "\n    >\n      <span\n    class="gatsby-resp-image-background-image"\n    style="padding-bottom: 58.78378378378378%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABcSAAAXEgFnn9JSAAACgUlEQVR42mNgwA/EGBgYlKE0HwMDAz8DA4M8AwODEgMDAxdWHZPmr/K+9+SF3////11u3brFjiynpaXFBqI7Ojq0s7JyO83NrYqEhIRABnMwMDAwYzWwYtX+v6tP3Pz/////58cfb1aN2cnAPe1SlGD/eX+B3h2hQiA1/lFOya6unv+NDE1f2MoFSkK1MmI1sGHirL+FdW3/ly9f+nL/wzkm1adMZKddilKadCFUsfdYqMq2/x6iudXxuX4+nv9zMrLeN/isCmdgCGWur69nQjKUEY6fP7jp3dPZ5NfV1eXy//9/FC9DNTFcv39eoaxies/GbSdz/1/5L5SsOFVvZtoZ1v3796vs2bNHb+bMmaxYXfv/PwMjCq5nYIKI/2d9Wl23+XFjSwGIny3VJtzivSFwzeo1t/fs3fOns7PTBBRhgoKC/PgN/F8PM5DzRXXx43ftDf0gfhJDKW+T24a4ObPm3d28ZfOv2tpacwYGBkkeHh4Rhr6Fy0xu3H1k+vPnT/3///+zoFrwHxxGR85ukMpK7uowM/ZJL3Yt5s4xWKTfG3qMs6OvQ3v+/PkW9fX1bIhIWXvw7/YrT0Cx/GL/oxU6Fbs1hGeeiZaccjJUomNtoMz//8XcAVFOGc4urv+NjczeJmi1hM6338+BFtOISKnon/U3v679/+ZN61/seTxbL++4ovjEi4Eyvee9paffDJX+/z+GO6kwMMvZyfl/bHTsq2kFW5Rgrg8NDWVetWoVano8d+ZMSkdHR3pfX180KKyQvSosLMzLwMDAAvJWZWXlihUrVnQvWrQIlGsEYIkeL0COEBCfm5tBjJOTQZqXl0EYmvVAFkgzMDBIQXMLBgAAhb0YCPHGxSkAAAAASUVORK5CYII=\'); background-size: cover; display: block;"\n  ></span>\n  <picture>\n          <source\n              srcset="/static/0340deb42b7103aa574a14527451c2ab/cbe2e/architecture.webp 148w,\n/static/0340deb42b7103aa574a14527451c2ab/3084c/architecture.webp 295w,\n/static/0340deb42b7103aa574a14527451c2ab/5ca24/architecture.webp 590w,\n/static/0340deb42b7103aa574a14527451c2ab/487e2/architecture.webp 625w"\n              sizes="(max-width: 590px) 100vw, 590px"\n              type="image/webp"\n            />\n          <source\n            srcset="/static/0340deb42b7103aa574a14527451c2ab/12f09/architecture.png 148w,\n/static/0340deb42b7103aa574a14527451c2ab/e4a3f/architecture.png 295w,\n/static/0340deb42b7103aa574a14527451c2ab/fcda8/architecture.png 590w,\n/static/0340deb42b7103aa574a14527451c2ab/80d71/architecture.png 625w"\n            sizes="(max-width: 590px) 100vw, 590px"\n            type="image/png"\n          />\n          <img\n            class="gatsby-resp-image-image"\n            src="/static/0340deb42b7103aa574a14527451c2ab/fcda8/architecture.png"\n            alt="architecture globale"\n            title=""\n            loading="lazy"\n            decoding="async"\n            style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"\n          />\n        </picture>\n    </span>'}}),"\n",t.createElement(e.p,null,"Comme vous le voyez, l’application est dédoublée sur deux serveurs distincts qui ont interdiction de\nse parler, en dehors de la base de données. Nous avons été confrontés à des problématiques de\nperformances qui nous a contraint d’utiliser le ",t.createElement(e.strong,null,"cache de Doctrine"),"."),"\n",t.createElement(e.p,null,"Il faut savoir qu’il y a\n",t.createElement(e.a,{href:"http://doctrine-orm.readthedocs.org/en/latest/reference/caching.html"},"3 types de cache pour Doctrine"),"\n:"),"\n",t.createElement(e.ul,null,"\n",t.createElement(e.li,null,"Query Cache : transformation DQL -> SQL;"),"\n",t.createElement(e.li,null,"Result Cache : résultat de la requête;"),"\n",t.createElement(e.li,null,"Metadata Cache : annotation des entities."),"\n"),"\n",t.createElement(e.p,null,"Si on regarde\n",t.createElement(e.a,{href:"http://doctrine-orm.readthedocs.org/en/latest/reference/caching.html#cache-drivers"},"la liste des drivers"),",\non s’aperçoit qu’il n’est pas évident de mutualiser du cache entre plusieurs serveur (qui ne peuvent\npas communiquer directement ensemble)."),"\n",t.createElement(e.p,null,"C’est là que Redis arrive ♥"),"\n",t.createElement(e.p,null,"En quelques mots, Redis (pour ",t.createElement(e.em,null,"REmote DIctionary Server"),") est un SGBD ",t.createElement(e.strong,null,"clé-valeur")," qui s’inscrit\ndans la mouvance NoSQL. En plus d’être simple d’utilisation, sa performance qui ferait pâlir Usain\nBolt. Cela est principalement dû au fait que tout est persisté dans le cache du serveur. Si vous\ndoutez encore de cette dernière phrase, sachez que\n",t.createElement(e.a,{href:"http://highscalability.com/blog/2012/4/2/youporn-targeting-200-million-views-a-day-and-beyond.html"},"YouPorn"),",\n",t.createElement(e.a,{href:"http://nickcraver.com/blog/2016/02/17/stack-overflow-the-architecture-2016-edition/"},"Stack Overflow"),",\n",t.createElement(e.a,{href:"https://github.com/blog/530-how-we-made-github-fast"},"Github"),"… l’utilisent ;-)"),"\n",t.createElement(e.p,null,"Voici un exemple de fonctionnement :"),"\n",t.createElement(e.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token operator">></span> SET name <span class="token string">"maxence"</span>\nOK\n<span class="token operator">></span> GET name\n<span class="token string">"maxence"</span>\n<span class="token operator">></span> KEYS *\n<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"name"</span>\n<span class="token comment"># Assigner un TTL sur une variable</span>\n<span class="token operator">></span> SETEX mission <span class="token number">10</span> <span class="token string">"votre mission si vous l\'acceptez... ce message s\'autodétruira dans 10s"</span>\nOK\n<span class="token comment"># 10\' après, le couple clef/valeur a disparu</span>\n<span class="token operator">></span> GET mission\n<span class="token punctuation">(</span>nil<span class="token punctuation">)</span></code></pre></div>'}}),"\n",t.createElement(e.h2,{id:"installation",style:{position:"relative"}},t.createElement(e.a,{href:"#installation","aria-label":"installation permalink",className:"anchor before"},t.createElement(e.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"Installation"),"\n",t.createElement(e.p,null,"L’installation de Redis est plutôt simple et se fait en quelques lignes de commande :"),"\n",t.createElement(e.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># download</span>\n<span class="token function">wget</span> http://download.redis.io/redis-stable.tar.gz\n<span class="token function">tar</span> xvzf redis-stable.tar.gz\n<span class="token builtin class-name">cd</span> redis-stable\n<span class="token function">make</span>\n<span class="token comment"># install</span>\n<span class="token function">sudo</span> <span class="token function">make</span> <span class="token function">install</span>\n<span class="token comment"># start</span>\nredis-server</code></pre></div>'}}),"\n",t.createElement(e.p,null,"Il va ensuite falloir installer les bundles qui vont bien :"),"\n",t.createElement(e.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token function">composer</span> require snc/redis-bundle <span class="token number">2</span>.x-dev\n<span class="token function">composer</span> require predis/predis ^1.0</code></pre></div>'}}),"\n",t.createElement(e.p,null,"Et on modifie le app/AppKernel.php:"),"\n",t.createElement(e.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="php"><pre class="language-php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>\n<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">registerBundles</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token punctuation">{</span>\n    <span class="token variable">$bundles</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span>\n        <span class="token comment">// ...</span>\n        <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified">Snc<span class="token punctuation">\\</span>RedisBundle<span class="token punctuation">\\</span>SncRedisBundle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>\n        <span class="token comment">// ...</span>\n    <span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">//...</span>\n<span class="token punctuation">}</span></span></code></pre></div>'}}),"\n",t.createElement(e.p,null,"Dans le config.yml :"),"\n",t.createElement(e.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">imports</span><span class="token punctuation">:</span>\n  <span class="token punctuation">-</span> <span class="token punctuation">{</span> <span class="token key atrule">resource</span><span class="token punctuation">:</span> redis.yml <span class="token punctuation">}</span>\n\n<span class="token comment"># Doctrine Configuration</span>\n<span class="token key atrule">doctrine</span><span class="token punctuation">:</span>\n  <span class="token key atrule">dbal</span><span class="token punctuation">:</span>\n    <span class="token comment">#...</span>\n  <span class="token key atrule">orm</span><span class="token punctuation">:</span>\n    <span class="token key atrule">auto_generate_proxy_classes</span><span class="token punctuation">:</span> <span class="token string">\'%kernel.debug%\'</span>\n    <span class="token key atrule">naming_strategy</span><span class="token punctuation">:</span> doctrine.orm.naming_strategy.underscore\n    <span class="token comment"># IMPORTANT!</span>\n    <span class="token key atrule">auto_mapping</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>\n    <span class="token key atrule">metadata_cache_driver</span><span class="token punctuation">:</span> redis\n    <span class="token key atrule">query_cache_driver</span><span class="token punctuation">:</span> redis\n\n<span class="token comment"># redis.yml</span>\n<span class="token key atrule">snc_redis</span><span class="token punctuation">:</span>\n  <span class="token key atrule">clients</span><span class="token punctuation">:</span>\n    <span class="token key atrule">default</span><span class="token punctuation">:</span>\n      <span class="token key atrule">type</span><span class="token punctuation">:</span> predis\n      <span class="token key atrule">alias</span><span class="token punctuation">:</span> default\n      <span class="token key atrule">dsn</span><span class="token punctuation">:</span> redis<span class="token punctuation">:</span>//1.2.3.4\n    <span class="token key atrule">doctrine</span><span class="token punctuation">:</span>\n      <span class="token key atrule">type</span><span class="token punctuation">:</span> predis\n      <span class="token key atrule">alias</span><span class="token punctuation">:</span> doctrine\n      <span class="token key atrule">dsn</span><span class="token punctuation">:</span> redis<span class="token punctuation">:</span>//1.2.3.4\n  <span class="token key atrule">doctrine</span><span class="token punctuation">:</span>\n    <span class="token key atrule">metadata_cache</span><span class="token punctuation">:</span>\n      <span class="token key atrule">client</span><span class="token punctuation">:</span> doctrine\n      <span class="token key atrule">entity_manager</span><span class="token punctuation">:</span> default\n      <span class="token key atrule">document_manager</span><span class="token punctuation">:</span> default\n    <span class="token key atrule">result_cache</span><span class="token punctuation">:</span>\n      <span class="token key atrule">client</span><span class="token punctuation">:</span> doctrine\n      <span class="token key atrule">entity_manager</span><span class="token punctuation">:</span> default\n    <span class="token key atrule">query_cache</span><span class="token punctuation">:</span>\n      <span class="token key atrule">client</span><span class="token punctuation">:</span> doctrine\n      <span class="token key atrule">entity_manager</span><span class="token punctuation">:</span> default</code></pre></div>'}}),"\n",t.createElement(e.p,null,"Et voilà pour l’installation.",t.createElement(e.br),"\n","A ce stade, seuls les caches de metadata et de query sont opérationnels. Pour la mise en cache du\nrésultat, il faudra le faire ",t.createElement(e.strong,null,"manuellement sur chaque requête"),"."),"\n",t.createElement(e.h2,{id:"mettre-en-cache-le-résultat",style:{position:"relative"}},t.createElement(e.a,{href:"#mettre-en-cache-le-r%C3%A9sultat","aria-label":"mettre en cache le résultat permalink",className:"anchor before"},t.createElement(e.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"Mettre en cache le résultat"),"\n",t.createElement(e.p,null,"Terminé les requêtes ",t.createElement(e.em,null,"inlines")," dans les controllers ! Vous allez désormais devoir utiliser le\n",t.createElement("abbr",{title:"Doctrine Query Language"},"DQL")," ou le QueryBuilder."),"\n",t.createElement(e.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="php"><pre class="language-php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>\n<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">findBeers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n<span class="token punctuation">{</span>\n    <span class="token variable">$query</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">getEntityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n        <span class="token operator">-></span><span class="token function">createQuery</span><span class="token punctuation">(</span>\n            <span class="token string single-quoted-string">\'select beers from MaxpouBeerBundle:Beers b\'</span>\n        <span class="token punctuation">)</span>\n    <span class="token punctuation">;</span>\n\n    <span class="token variable">$query</span><span class="token operator">-></span><span class="token function">useResultCache</span><span class="token punctuation">(</span><span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token variable">$query</span><span class="token operator">-></span><span class="token function">setResultCacheLifetime</span><span class="token punctuation">(</span><span class="token number">3600</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//3600sec = 1 hour</span>\n\n    <span class="token keyword">return</span> <span class="token variable">$query</span><span class="token operator">-></span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span></span></code></pre></div>'}}),"\n",t.createElement(e.p,null,"Maintenant, si l’on recharge la page, cette requête ne se fera plus via MySQL mais bien via Redis.\nOn peut vérifier tout cela en allant sur Redis et en rentrant la commande suivante : ",t.createElement(e.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">KEYS *</code>'}}),". Voici\nce que l’on va avoir :"),"\n",t.createElement(e.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token operator">></span> KEYS *\n<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"[Maxpou<span class="token entity" title="\\\\">\\\\</span>BeerBundle<span class="token entity" title="\\\\">\\\\</span>Entity<span class="token entity" title="\\\\">\\\\</span>Beer<span class="token variable">$CLASSMETADATA</span>][1]"</span>\n<span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"[809cd863587594a754a7ffda5c2c06ee4640ebe3][1]"</span></code></pre></div>'}}),"\n",t.createElement(e.p,null,"La première ligne va contenir les métadonnées de la classe Beer. La seconde, contiendra la requête\n",t.createElement(e.strong,null,"et")," son résultat. Si vous voulez avoir une clé un peu plus digeste, vous pouvez utiliser cette\nméthode ",t.createElement(e.span,{dangerouslySetInnerHTML:{__html:"<code class=\"language-text\">$query->setResultCacheId('my_wonderful_key');</code>"}})," ou même faire ",t.createElement(e.strong,null,"1 pierre 3 coups")," :\n",t.createElement(e.span,{dangerouslySetInnerHTML:{__html:"<code class=\"language-text\">$query->useResultCache(true, 3600, 'my_wonderful_key');</code>"}}),"."),"\n",t.createElement(e.p,null,"Voici ce que nous aurons : (je n’ai pas réussi à supprimer le ",t.createElement(e.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">[1]</code>'}}),")"),"\n",t.createElement(e.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token operator">></span> KEYS *\n<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"[Maxpou<span class="token entity" title="\\\\">\\\\</span>BeerBundle<span class="token entity" title="\\\\">\\\\</span>Entity<span class="token entity" title="\\\\">\\\\</span>Beer<span class="token variable">$CLASSMETADATA</span>][1]"</span>\n<span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"[my_wonderful_key][1]"</span></code></pre></div>'}}),"\n",t.createElement(e.p,null,"Pour nettoyer le cache, voici quelques commandes :"),"\n",t.createElement(e.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="bash"><pre class="language-bash"><code class="language-bash"><span class="token comment"># Nettoyer cache des queries</span>\nphp app/console doctrine:cache:clear-query\n<span class="token comment"># Nettoyer cache des metadatas</span>\nphp app/console doctrine:cache:clear-metadata\n<span class="token comment"># Nettoyer cache des résultats</span>\nphp app/console doctrine:cache:clear-result\n<span class="token comment"># Vider la base redis</span>\nphp app/console redis:flushdb</code></pre></div>'}}),"\n",t.createElement(e.h2,{id:"invalider-le-cache-des-requêtes",style:{position:"relative"}},t.createElement(e.a,{href:"#invalider-le-cache-des-requ%C3%AAtes","aria-label":"invalider le cache des requêtes permalink",className:"anchor before"},t.createElement(e.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"Invalider le cache des requêtes"),"\n",t.createElement(e.p,null,"C’est bien de mettre en place un système de cache, mais vous n’allez pas demander à vos utilisateurs\nde lancer la commande après chaque opération. Il va donc falloir utiliser les événements de\nDoctrine, et plus particulièrement\nl’",t.createElement(e.a,{href:"http://doctrine-orm.readthedocs.org/projects/doctrine-orm/en/latest/reference/events.html#entity-listeners"},"entity listeners"),"\nSi vous faites des tests, pensez à commenter le cache des métadonnées ;-)"),"\n",t.createElement(e.p,null,"Définissez le service :"),"\n",t.createElement(e.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="php"><pre class="language-php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>\n\n<span class="token keyword">namespace</span> <span class="token package">Maxpou<span class="token punctuation">\\</span>BeerBundle<span class="token punctuation">\\</span>Service</span><span class="token punctuation">;</span>\n\n<span class="token keyword">use</span> <span class="token package">Doctrine<span class="token punctuation">\\</span>ORM<span class="token punctuation">\\</span>Event<span class="token punctuation">\\</span>LifecycleEventArgs</span><span class="token punctuation">;</span>\n<span class="token keyword">use</span> <span class="token package">Maxpou<span class="token punctuation">\\</span>BeerBundle<span class="token punctuation">\\</span>Entity<span class="token punctuation">\\</span>Beer</span><span class="token punctuation">;</span>\n\n<span class="token keyword">class</span> <span class="token class-name-definition class-name">BeerListener</span>\n<span class="token punctuation">{</span>\n    <span class="token keyword">private</span> <span class="token variable">$cacheDriver</span><span class="token punctuation">;</span>\n\n    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$cacheDriver</span><span class="token punctuation">)</span>\n    <span class="token punctuation">{</span>\n        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">cacheDriver</span> <span class="token operator">=</span> <span class="token variable">$cacheDriver</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">postPersist</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Beer</span> <span class="token variable">$beer</span><span class="token punctuation">,</span> <span class="token class-name type-declaration">LifecycleEventArgs</span> <span class="token variable">$args</span><span class="token punctuation">)</span>\n    <span class="token punctuation">{</span>\n        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">cacheDriver</span><span class="token operator">-></span><span class="token function">expire</span><span class="token punctuation">(</span><span class="token string single-quoted-string">\'[beers_all][1]\'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">postUpdate</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Beer</span> <span class="token variable">$beer</span><span class="token punctuation">,</span> <span class="token class-name type-declaration">LifecycleEventArgs</span> <span class="token variable">$args</span><span class="token punctuation">)</span>\n    <span class="token punctuation">{</span>\n        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">cacheDriver</span><span class="token operator">-></span><span class="token function">expire</span><span class="token punctuation">(</span><span class="token string single-quoted-string">\'[beers_all][1]\'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n\n    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">postRemove</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Beer</span> <span class="token variable">$beer</span><span class="token punctuation">,</span> <span class="token class-name type-declaration">LifecycleEventArgs</span> <span class="token variable">$args</span><span class="token punctuation">)</span>\n    <span class="token punctuation">{</span>\n        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">cacheDriver</span><span class="token operator">-></span><span class="token function">expire</span><span class="token punctuation">(</span><span class="token string single-quoted-string">\'[beers_all][1]\'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span></span></code></pre></div>'}}),"\n",t.createElement(e.p,null,"Ici, ",t.createElement(e.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">beer_all</code>'}})," est le nom de l’id assigné au cache."),"\n",t.createElement(e.p,null,"Le service.yml :"),"\n",t.createElement(e.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="yaml"><pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">beer_listener</span><span class="token punctuation">:</span>\n  <span class="token key atrule">class</span><span class="token punctuation">:</span> Maxpou\\BeerBundle\\Service\\BeerListener\n  <span class="token key atrule">arguments</span><span class="token punctuation">:</span>\n    <span class="token punctuation">-</span> <span class="token string">\'@snc_redis.doctrine\'</span>\n  <span class="token key atrule">tags</span><span class="token punctuation">:</span>\n    <span class="token punctuation">-</span> <span class="token punctuation">{</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> doctrine.orm.entity_listener <span class="token punctuation">}</span></code></pre></div>'}}),"\n",t.createElement(e.p,null,"Et enfin l’annotation sur l’entity :"),"\n",t.createElement(e.span,{dangerouslySetInnerHTML:{__html:'<div class="gatsby-highlight" data-language="php"><pre class="language-php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>\n<span class="token comment">/**\n * Beer\n *\n * @ORM\\Table(name="beers")\n * @ORM\\Entity(repositoryClass="Maxpou\\BeerBundle\\Repository\\BeerRepository")\n * @ORM\\EntityListeners({"Maxpou\\BeerBundle\\Service\\BeerListener"})\n */</span>\n<span class="token keyword">class</span> <span class="token class-name-definition class-name">Beer</span> <span class="token keyword">implements</span> <span class="token class-name">BeerInterface</span>\n<span class="token punctuation">{</span>\n<span class="token comment">//...</span></span></code></pre></div>'}}),"\n",t.createElement(e.p,null,"Les plus pointilleux d’entre vous auront remarqués que je redéfini le TTL de ma clef au lieu de la\nsupprimer. En effet, si je supprime ma clef, la nouvelle clef créée sera ",t.createElement(e.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">[beers_all][2]</code>'}}),". Et le\ncompteur augmentera ainsi de suite…",t.createElement(e.br),"\n","Avec cette technique ",t.createElement("s",null,"de fainéant"),", on garde la main sur le nom de la clef qui sera toujours\n",t.createElement(e.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">[beers_all][1]</code>'}}),"."),"\n",t.createElement(e.h2,{id:"pour-aller-plus-loin",style:{position:"relative"}},t.createElement(e.a,{href:"#pour-aller-plus-loin","aria-label":"pour aller plus loin permalink",className:"anchor before"},t.createElement(e.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"Pour aller plus loin"),"\n",t.createElement(e.ul,null,"\n",t.createElement(e.li,null,"Tutoriel/Sandbox Redis : ",t.createElement(e.a,{href:"http://try.redis.io"},"http://try.redis.io")),"\n",t.createElement(e.li,null,t.createElement(e.a,{href:"http://doctrine-orm.readthedocs.org/projects/doctrine-orm/en/latest/reference/second-level-cache.html"},"2e niveau de cache de Doctrine (encore à l’état expérimental)")),"\n"),"\n",t.createElement(e.h2,{id:"tips",style:{position:"relative"}},t.createElement(e.a,{href:"#tips","aria-label":"tips permalink",className:"anchor before"},t.createElement(e.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"Tips"),"\n",t.createElement(e.p,null,"Utiliser les pipes unix avec le redis-cli : ",t.createElement(e.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">echo "KEYS *" | ./path/to/redis-cli | grep beer</code>'}}),t.createElement(e.br),"\n","Vérifier le ",t.createElement("abbr",{title:"Time To Live"},"TTL")," d’une clef: ",t.createElement(e.span,{dangerouslySetInnerHTML:{__html:'<code class="language-text">TTL [beer-id-42][1]</code>'}})))}var p=function(n){void 0===n&&(n={});const{wrapper:e}=Object.assign({},(0,s.ah)(),n.components);return e?t.createElement(e,n,t.createElement(l,n)):l(n)},c=a(4222),o=a(418),r=a(4529),i=a(7953),u=a(4849),d=a(5536),k=a(2404);function m(n){let{data:e,pageContext:a,children:s,location:l}=n;const p=e.post,{previous:m,next:g}=a;return t.createElement(c.Z,{location:l},t.createElement(d.Z,{title:p.frontmatter.title,description:p.frontmatter.description||p.excerpt,cover:p.frontmatter.cover&&p.frontmatter.cover.publicURL,imageShare:p.frontmatter.imageShare&&p.frontmatter.imageShare.publicURL,lang:p.frontmatter.language,translations:p.frontmatter.translations,path:p.frontmatter.slug,isBlogPost:!0}),t.createElement(r.Z,{heroImg:p.frontmatter.cover,title:p.frontmatter.title}),t.createElement(o.Z,null,t.createElement(i.Z,{post:p},s)),t.createElement(o.Z,{as:"aside"},t.createElement(k.Z,{slug:p.frontmatter.slug,title:p.frontmatter.title,redditPostId:p.frontmatter.redditPostId})),t.createElement(u.Z,{previous:m,next:g}))}function g(n){return t.createElement(m,n,t.createElement(p,n))}}}]);
//# sourceMappingURL=component---src-templates-blog-post-js-content-file-path-content-posts-2016-2016-03-08-cache-doctrine-avec-redis-index-md-f742cbbee3b5caf502be.js.map