<!DOCTYPE html><html lang="fr"> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/x-icon" href="/favicon.ico"><meta name="generator" content="Astro v4.4.0"><!-- Font preloads --><link href="https://fonts.googleapis.com/css?family=Lato:400,700&display=swap" rel="stylesheet"><!-- Canonical URL --><link rel="canonical" href="https://www.maxpou.fr/blog/cache-doctrine-avec-redis/"><!-- Primary Meta Tags --><title>Utiliser Redis pour stocker le cache de Doctrine</title><meta name="title" content="Utiliser Redis pour stocker le cache de Doctrine"><meta name="description" content="Améliorer les performances de doctrine en utilisant son cache et en stockant les informations sur Redis"><script async defer data-domain="maxpou.fr" src="https://plausible.io/js/plausible.js"></script><link rel="alternate" type="application/rss+xml" title="Maxence Poutord • Maxpou Blog" href="/rss.xml"><link rel="sitemap" type="application/xml" href="/sitemap-index.xml"><!-- Open Graph / Facebook --><meta property="og:type" content="article"><meta property="og:url" content="https://www.maxpou.fr/blog/cache-doctrine-avec-redis/"><meta property="og:title" content="Utiliser Redis pour stocker le cache de Doctrine"><meta property="og:description" content="Améliorer les performances de doctrine en utilisant son cache et en stockant les informations sur Redis"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://www.maxpou.fr/blog/cache-doctrine-avec-redis/"><meta property="twitter:title" content="Utiliser Redis pour stocker le cache de Doctrine"><meta property="twitter:description" content="Améliorer les performances de doctrine en utilisant son cache et en stockant les informations sur Redis"><meta name="twitter:creator" content="_maxpou"><script>
  const theme = (() => {
    if (typeof localStorage !== 'undefined' && localStorage.getItem('theme')) {
      return localStorage.getItem('theme')
    }
    if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
      return 'dark'
    }
    return 'light'
  })()

  if (theme === 'light') {
    document.documentElement.classList.remove('dark')
  } else {
    document.documentElement.classList.add('dark')
  }
  window.localStorage.setItem('theme', theme)
</script><link rel="stylesheet" href="/_astro/_slug_.cE4nuJce.css" />
<style>code[class*=language-],pre[class*=language-]{color:#ccc;background:none;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;hyphens:none}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#2d2d2d}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.comment,.token.block-comment,.token.prolog,.token.doctype,.token.cdata{color:#999}.token.punctuation{color:#ccc}.token.tag,.token.attr-name,.token.namespace,.token.deleted{color:#e2777a}.token.function-name{color:#6196cc}.token.boolean,.token.number,.token.function{color:#f08d49}.token.property,.token.class-name,.token.constant,.token.symbol{color:#f8c555}.token.selector,.token.important,.token.atrule,.token.keyword,.token.builtin{color:#cc99cd}.token.string,.token.char,.token.attr-value,.token.regex,.token.variable{color:#7ec699}.token.operator,.token.entity,.token.url{color:#67cdcc}.token.important,.token.bold{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.inserted{color:green}.expressive-code{margin-top:1em}
</style>
<link rel="stylesheet" href="/_astro/_slug_.fA4gFHjB.css" />
<style>a[data-astro-cid-eimmu3lg]{display:inline-block;text-decoration:none;border-bottom:4px solid transparent}a[data-astro-cid-eimmu3lg].active{font-weight:bolder;border-bottom-color:#ffdc4e}footer[data-astro-cid-sz7xmlte]{padding:2em 1em 6em;color:rgb(var(--gray))}*{transition:background .5s ease}*::-moz-selection{background-color:#ffdc4e;color:#3e4047}*::selection{background-color:#ffdc4e;color:#3e4047}
</style><script type="module">const n=document.getElementById("burger-button"),e=document.getElementById("burger-line-1"),r=document.getElementById("burger-line-2"),t=document.getElementById("burger-line-3"),o=document.getElementById("menu-backdrop");n.addEventListener("click",()=>{o.classList.contains("hidden")?(o.classList.add("flex"),o.classList.remove("hidden"),e.style.transform="rotate(45deg)",e.style.top="0",e.style.backgroundColor="white",r.style.backgroundColor="transparent",t.style.transform="rotate(-45deg)",t.style.top="0",t.style.backgroundColor="white"):(e.style.transform="rotate(0)",e.style.removeProperty("top"),e.style.removeProperty("background-color"),r.style.removeProperty("background-color"),t.style.removeProperty("background-color"),t.style.transform="rotate(0)",t.style.removeProperty("top"),o.classList.add("hidden"),o.classList.remove("flex"))});
</script></head> <body class="bg-gradient-to-b from-blue-50 to-[#f5f7f9] dark:bg-gray-600 dark:bg-gradient-to-b dark:from-gray-600"> <header class="bg-white dark:bg-gray-600 px-4 h-16"> <nav class="dark:text-white h-16 flex items-center justify-between max-w-screen-xl w-full mx-auto"> <h1 class="text-lg dark:text-white font-bold"> <a href="/">Maxence Poutord</a> </h1> <div class="md:flex hidden"> <a href="/blog" class="py-4 px-2 no-underline text-lg hover:text-blue-900 dark:text-white dark:hover:text-mainYellow" data-astro-cid-eimmu3lg> Blog </a>  <a href="/speaking" class="py-4 px-2 no-underline text-lg hover:text-blue-900 dark:text-white dark:hover:text-mainYellow" data-astro-cid-eimmu3lg> Speaking </a>  <a href="/about" class="py-4 px-2 no-underline text-lg hover:text-blue-900 dark:text-white dark:hover:text-mainYellow" data-astro-cid-eimmu3lg> About </a>  <style>astro-island,astro-slot,astro-static-slot{display:contents}</style><script>(()=>{var e=async t=>{await(await t())()};(self.Astro||(self.Astro={})).only=e;window.dispatchEvent(new Event("astro:only"));})();;(()=>{var v=Object.defineProperty;var A=(c,s,a)=>s in c?v(c,s,{enumerable:!0,configurable:!0,writable:!0,value:a}):c[s]=a;var d=(c,s,a)=>(A(c,typeof s!="symbol"?s+"":s,a),a);var u;{let c={0:t=>m(t),1:t=>a(t),2:t=>new RegExp(t),3:t=>new Date(t),4:t=>new Map(a(t)),5:t=>new Set(a(t)),6:t=>BigInt(t),7:t=>new URL(t),8:t=>new Uint8Array(t),9:t=>new Uint16Array(t),10:t=>new Uint32Array(t)},s=t=>{let[e,n]=t;return e in c?c[e](n):void 0},a=t=>t.map(s),m=t=>typeof t!="object"||t===null?t:Object.fromEntries(Object.entries(t).map(([e,n])=>[e,s(n)]));customElements.get("astro-island")||customElements.define("astro-island",(u=class extends HTMLElement{constructor(){super(...arguments);d(this,"Component");d(this,"hydrator");d(this,"hydrate",async()=>{var f;if(!this.hydrator||!this.isConnected)return;let e=(f=this.parentElement)==null?void 0:f.closest("astro-island[ssr]");if(e){e.addEventListener("astro:hydrate",this.hydrate,{once:!0});return}let n=this.querySelectorAll("astro-slot"),r={},l=this.querySelectorAll("template[data-astro-template]");for(let o of l){let i=o.closest(this.tagName);i!=null&&i.isSameNode(this)&&(r[o.getAttribute("data-astro-template")||"default"]=o.innerHTML,o.remove())}for(let o of n){let i=o.closest(this.tagName);i!=null&&i.isSameNode(this)&&(r[o.getAttribute("name")||"default"]=o.innerHTML)}let h;try{h=this.hasAttribute("props")?m(JSON.parse(this.getAttribute("props"))):{}}catch(o){let i=this.getAttribute("component-url")||"<unknown>",b=this.getAttribute("component-export");throw b&&(i+=` (export ${b})`),console.error(`[hydrate] Error parsing props for component ${i}`,this.getAttribute("props"),o),o}let p;await this.hydrator(this)(this.Component,h,r,{client:this.getAttribute("client")}),this.removeAttribute("ssr"),this.dispatchEvent(new CustomEvent("astro:hydrate"))});d(this,"unmount",()=>{this.isConnected||this.dispatchEvent(new CustomEvent("astro:unmount"))})}disconnectedCallback(){document.removeEventListener("astro:after-swap",this.unmount),document.addEventListener("astro:after-swap",this.unmount,{once:!0})}connectedCallback(){if(!this.hasAttribute("await-children")||document.readyState==="interactive"||document.readyState==="complete")this.childrenConnectedCallback();else{let e=()=>{document.removeEventListener("DOMContentLoaded",e),n.disconnect(),this.childrenConnectedCallback()},n=new MutationObserver(()=>{var r;((r=this.lastChild)==null?void 0:r.nodeType)===Node.COMMENT_NODE&&this.lastChild.nodeValue==="astro:end"&&(this.lastChild.remove(),e())});n.observe(this,{childList:!0}),document.addEventListener("DOMContentLoaded",e)}}async childrenConnectedCallback(){let e=this.getAttribute("before-hydration-url");e&&await import(e),this.start()}async start(){let e=JSON.parse(this.getAttribute("opts")),n=this.getAttribute("client");if(Astro[n]===void 0){window.addEventListener(`astro:${n}`,()=>this.start(),{once:!0});return}try{await Astro[n](async()=>{let r=this.getAttribute("renderer-url"),[l,{default:h}]=await Promise.all([import(this.getAttribute("component-url")),r?import(r):()=>()=>{}]),p=this.getAttribute("component-export")||"default";if(!p.includes("."))this.Component=l[p];else{this.Component=l;for(let y of p.split("."))this.Component=this.Component[y]}return this.hydrator=h,this.hydrate},e,this)}catch(r){console.error(`[astro-island] Error hydrating ${this.getAttribute("component-url")}`,r)}}attributeChangedCallback(){this.hydrate()}},d(u,"observedAttributes",["props"]),u))}})();</script><astro-island uid="1MPqDn" component-url="/_astro/DarkModeButton.xNbp8Br3.js" component-export="default" renderer-url="/_astro/client.PcUt3MZx.js" props="{}" ssr="" client="only" opts="{&quot;name&quot;:&quot;DarkModeButton&quot;,&quot;value&quot;:&quot;preact&quot;}"></astro-island> </div> <button id="burger-button" aria-label="Toggle mobile menu" class="md:hidden block w-14 h-14 relative focus:outline-none rounded z-10"> <div class="block w-5 absolute left-6 top-1/2 transform -translate-x-1/2 -translate-y-1/2"> <span id="burger-line-1" class="block absolute h-0.5 w-7 text-white bg-gray-600 dark:bg-white transform transition-all duration-500 ease-in-out -top-2"></span> <span id="burger-line-2" class="block absolute h-0.5 w-7 text-white bg-gray-600 dark:bg-white transform transition-all duration-500 ease-in-out"></span> <span id="burger-line-3" class="block absolute h-0.5 w-7 text-white bg-gray-600 dark:bg-white transform transition-all duration-500 ease-in-out top-2"></span> </div> </button> </nav> <div id="menu-backdrop" class="hidden bg-gray-600 bg-opacity-95 absolute top-0 left-0 h-screen w-screen backdrop-opacity-90 items-center justify-center"> <ul class="text-white font-bold text-xl"> <li class="p-3"><a href="/">Home</a></li> <li class="p-3"><a href="/blog">Blog</a></li> <li class="p-3"><a href="/speaking">Speaking</a></li> <li class="p-3"><a href="/about">About</a></li> <li class="p-3"> <astro-island uid="lieIt" component-url="/_astro/DarkModeButton.xNbp8Br3.js" component-export="default" renderer-url="/_astro/client.PcUt3MZx.js" props="{&quot;textOnly&quot;:[0,true],&quot;className&quot;:[0,&quot;!p-0&quot;]}" ssr="" client="only" opts="{&quot;name&quot;:&quot;DarkModeButton&quot;,&quot;value&quot;:&quot;preact&quot;}"></astro-island> </li> </ul> </div> </header>  <main class="m-0 mx-auto min-h-[70vh] w-full max-w-screen-xl px-4 py-12 text-gray-500 dark:text-gray-100">  <article> <div class="hero-image"> <img src="/_astro/header.7cI3ujML_ZnkzkO.webp" alt="Cover picture for Utiliser Redis pour stocker le cache de Doctrine" class="rounded-xl shadow-xl mx-auto h-[500px] object-cover w-full" width="1020" height="500" loading="lazy" decoding="async"> </div> <div class="container m-auto text-center"> <div class="mt-3 text-blueGreyed dark:text-gray-300"> <time datetime="2016-03-08T00:00:00.000Z"> 8 March 2016 </time>  </div> <h1 class="font-bold text-3xl dark:text-white text-center leading-none py-4 mb-2 "> Utiliser Redis pour stocker le cache de Doctrine </h1> <div class="pb-6"> <a href="/tags/Symfony2" class="mr-2 inline-block rounded-lg bg-darkBlue px-3 py-2 text-sm text-white no-underline hover:bg-blueGreyed dark:bg-blueGreyed dark:hover:bg-darkBlue"> Symfony2 </a><a href="/tags/Doctrine" class="mr-2 inline-block rounded-lg bg-darkBlue px-3 py-2 text-sm text-white no-underline hover:bg-blueGreyed dark:bg-blueGreyed dark:hover:bg-darkBlue"> Doctrine </a><a href="/tags/Redis" class="mr-2 inline-block rounded-lg bg-darkBlue px-3 py-2 text-sm text-white no-underline hover:bg-blueGreyed dark:bg-blueGreyed dark:hover:bg-darkBlue"> Redis </a>  </div> </div> <div class="m-auto w-[720px] max-w-full">  <div class="prose
  max-w-none
  dark:prose-invert
  prose-headings:underline
  prose-h2:text-2xl prose-h2:font-bold prose-h2:dark:text-mainYellow
  prose-h3:text-xl prose-h3:font-bold
  prose-p:mb-0
  prose-p:mt-4
  prose-a:underline-offset-4
  prose-a:decoration-2
  prose-a:text-gray-700 dark:prose-a:text-slate-100 hover:prose-a:text-slate-900
  prose-a:decoration-gray-300
  hover:prose-a:decoration-blue-700 dark:hover:prose-a:decoration-mainYellow
  prose-img:rounded-xl">  <blockquote>
<p>La meilleur requête est celle que l’on a pas à faire — <strong>un inconnu</strong></p>
</blockquote>
<p>Dans mon actuelle mission, nous développons une application sous Symfony2 avec Doctrine comme ORM.
Voici grossièrement à quoi ressemble l’architecture globale :</p>
<p><img  src="/_astro/architecture.MXVDjx4X_wD0lJ.webp" alt="architecture globale" width="625" height="369" loading="lazy" decoding="async"></p>
<p>Comme vous le voyez, l’application est dédoublée sur deux serveurs distincts qui ont interdiction de
se parler, en dehors de la base de données. Nous avons été confrontés à des problématiques de
performances qui nous a contraint d’utiliser le <strong>cache de Doctrine</strong>.</p>
<p>Il faut savoir qu’il y a
<a href="http://doctrine-orm.readthedocs.org/en/latest/reference/caching.html">3 types de cache pour Doctrine</a>
:</p>
<ul>
<li>Query Cache : transformation DQL -> SQL;</li>
<li>Result Cache : résultat de la requête;</li>
<li>Metadata Cache : annotation des entities.</li>
</ul>
<p>Si on regarde
<a href="http://doctrine-orm.readthedocs.org/en/latest/reference/caching.html#cache-drivers">la liste des drivers</a>,
on s’aperçoit qu’il n’est pas évident de mutualiser du cache entre plusieurs serveur (qui ne peuvent
pas communiquer directement ensemble).</p>
<p>C’est là que Redis arrive ♥</p>
<p>En quelques mots, Redis (pour <em>REmote DIctionary Server</em>) est un SGBD <strong>clé-valeur</strong> qui s’inscrit
dans la mouvance NoSQL. En plus d’être simple d’utilisation, sa performance qui ferait pâlir Usain
Bolt. Cela est principalement dû au fait que tout est persisté dans le cache du serveur. Si vous
doutez encore de cette dernière phrase, sachez que
<a href="http://highscalability.com/blog/2012/4/2/youporn-targeting-200-million-views-a-day-and-beyond.html">YouPorn</a>,
<a href="http://nickcraver.com/blog/2016/02/17/stack-overflow-the-architecture-2016-edition/">Stack Overflow</a>,
<a href="https://github.com/blog/530-how-we-made-github-fast">Github</a>… l’utilisent ;-)</p>
<p>Voici un exemple de fonctionnement :</p>
<div class="expressive-code"><link rel="stylesheet" href="/_astro/ec.aqfpi.css"><script type="module" src="/_astro/ec.sgewm.js"></script><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#89DDFF">></span><span style="--0:#BABED8"> SET name </span><span style="--0:#89DDFF">"</span><span style="--0:#C3E88D">maxence</span><span style="--0:#89DDFF">"</span></div><div class="ec-line"><span style="--0:#FFCB6B">OK</span></div><div class="ec-line"><span style="--0:#89DDFF">></span><span style="--0:#BABED8"> GET name</span></div><div class="ec-line"><span style="--0:#FFCB6B">"maxence"</span></div><div class="ec-line"><span style="--0:#89DDFF">></span><span style="--0:#BABED8"> KEYS </span><span style="--0:#89DDFF">*</span></div><div class="ec-line"><span style="--0:#FFCB6B">1</span><span style="--0:#BABED8">) </span><span style="--0:#89DDFF">"</span><span style="--0:#C3E88D">name</span><span style="--0:#89DDFF">"</span></div><div class="ec-line"><span style="--0:#9FA4BC;--0fs:italic"># Assigner un TTL sur une variable</span></div><div class="ec-line"><span style="--0:#89DDFF">></span><span style="--0:#BABED8"> SETEX mission 10 </span><span style="--0:#89DDFF">"</span><span style="--0:#C3E88D">votre mission si vous l'acceptez... ce message s'autodétruira dans 10s</span><span style="--0:#89DDFF">"</span></div><div class="ec-line"><span style="--0:#FFCB6B">OK</span></div><div class="ec-line"><span style="--0:#9FA4BC;--0fs:italic"># 10' après, le couple clef/valeur a disparu</span></div><div class="ec-line"><span style="--0:#89DDFF">></span><span style="--0:#BABED8"> GET mission</span></div><div class="ec-line"><span style="--0:#89DDFF">(</span><span style="--0:#FFCB6B">nil</span><span style="--0:#89DDFF">)</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="> SET name &#x22;maxence&#x22;OK> GET name&#x22;maxence&#x22;> KEYS *1) &#x22;name&#x22;> SETEX mission 10 &#x22;votre mission si vous l&#x27;acceptez... ce message s&#x27;autodétruira dans 10s&#x22;OK> GET mission(nil)"><div></div></button></div></figure></div>
<h2 id="installation">Installation</h2>
<p>L’installation de Redis est plutôt simple et se fait en quelques lignes de commande :</p>
<div class="expressive-code"><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#9FA4BC;--0fs:italic"># download</span></div><div class="ec-line"><span style="--0:#FFCB6B">wget</span><span style="--0:#BABED8"> </span><span style="--0:#C3E88D">http://download.redis.io/redis-stable.tar.gz</span></div><div class="ec-line"><span style="--0:#FFCB6B">tar</span><span style="--0:#BABED8"> </span><span style="--0:#C3E88D">xvzf</span><span style="--0:#BABED8"> </span><span style="--0:#C3E88D">redis-stable.tar.gz</span></div><div class="ec-line"><span style="--0:#82AAFF">cd</span><span style="--0:#BABED8"> </span><span style="--0:#C3E88D">redis-stable</span></div><div class="ec-line"><span style="--0:#FFCB6B">make</span></div><div class="ec-line"><span style="--0:#9FA4BC;--0fs:italic"># install</span></div><div class="ec-line"><span style="--0:#FFCB6B">sudo</span><span style="--0:#BABED8"> </span><span style="--0:#C3E88D">make</span><span style="--0:#BABED8"> </span><span style="--0:#C3E88D">install</span></div><div class="ec-line"><span style="--0:#9FA4BC;--0fs:italic"># start</span></div><div class="ec-line"><span style="--0:#FFCB6B">redis-server</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="wget http://download.redis.io/redis-stable.tar.gztar xvzf redis-stable.tar.gzcd redis-stablemakesudo make installredis-server"><div></div></button></div></figure></div>
<p>Il va ensuite falloir installer les bundles qui vont bien :</p>
<div class="expressive-code"><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#FFCB6B">composer</span><span style="--0:#BABED8"> </span><span style="--0:#C3E88D">require</span><span style="--0:#BABED8"> </span><span style="--0:#C3E88D">snc/redis-bundle</span><span style="--0:#BABED8"> </span><span style="--0:#F78C6C">2</span><span style="--0:#C3E88D">.x-dev</span></div><div class="ec-line"><span style="--0:#FFCB6B">composer</span><span style="--0:#BABED8"> </span><span style="--0:#C3E88D">require</span><span style="--0:#BABED8"> </span><span style="--0:#C3E88D">predis/predis</span><span style="--0:#BABED8"> </span><span style="--0:#C3E88D">^1.0</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="composer require snc/redis-bundle 2.x-devcomposer require predis/predis ^1.0"><div></div></button></div></figure></div>
<p>Et on modifie le app/AppKernel.php:</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#89DDFF">&#x3C;?</span><span style="--0:#BABED8">php</span></div><div class="ec-line"><span style="--0:#C792EA">public</span><span style="--0:#BABED8"> </span><span style="--0:#C792EA">function</span><span style="--0:#BABED8"> </span><span style="--0:#82AAFF">registerBundles</span><span style="--0:#89DDFF">()</span></div><div class="ec-line"><span style="--0:#89DDFF">{</span></div><div class="ec-line"><span style="--0:#BABED8">    </span><span style="--0:#89DDFF">$</span><span style="--0:#BABED8">bundles </span><span style="--0:#89DDFF">=</span><span style="--0:#BABED8"> </span><span style="--0:#82AAFF">array</span><span style="--0:#89DDFF">(</span></div><div class="ec-line"><span style="--0:#89DDFF">        </span><span style="--0:#9FA4BC;--0fs:italic">// ...</span></div><div class="ec-line"><span style="--0:#BABED8">        </span><span style="--0:#F78C6C">new</span><span style="--0:#BABED8"> Snc</span><span style="--0:#89DDFF">\</span><span style="--0:#BABED8">RedisBundle</span><span style="--0:#89DDFF">\</span><span style="--0:#FFCB6B">SncRedisBundle</span><span style="--0:#89DDFF">(),</span></div><div class="ec-line"><span style="--0:#89DDFF">        </span><span style="--0:#9FA4BC;--0fs:italic">// ...</span></div><div class="ec-line"><span style="--0:#BABED8">    </span><span style="--0:#89DDFF">);</span></div><div class="ec-line"><span style="--0:#89DDFF">    </span><span style="--0:#9FA4BC;--0fs:italic">//...</span></div><div class="ec-line"><span style="--0:#89DDFF">}</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="<?phppublic function registerBundles(){    $bundles = array(        // ...        new Snc\RedisBundle\SncRedisBundle(),        // ...    );    //...}"><div></div></button></div></figure></div>
<p>Dans le config.yml :</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#F2858B">imports</span><span style="--0:#89DDFF">:</span></div><div class="ec-line"><span style="--0:#BABED8">  </span><span style="--0:#89DDFF">-</span><span style="--0:#BABED8"> </span><span style="--0:#89DDFF">{</span><span style="--0:#BABED8"> </span><span style="--0:#F2858B">resource</span><span style="--0:#89DDFF">:</span><span style="--0:#BABED8"> </span><span style="--0:#C3E88D">redis.yml</span><span style="--0:#BABED8"> </span><span style="--0:#89DDFF">}</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#9FA4BC;--0fs:italic"># Doctrine Configuration</span></div><div class="ec-line"><span style="--0:#F2858B">doctrine</span><span style="--0:#89DDFF">:</span></div><div class="ec-line"><span style="--0:#BABED8">  </span><span style="--0:#F2858B">dbal</span><span style="--0:#89DDFF">:</span></div><div class="ec-line"><span style="--0:#89DDFF">    </span><span style="--0:#9FA4BC;--0fs:italic">#...</span></div><div class="ec-line"><span style="--0:#BABED8">  </span><span style="--0:#F2858B">orm</span><span style="--0:#89DDFF">:</span></div><div class="ec-line"><span style="--0:#BABED8">    </span><span style="--0:#F2858B">auto_generate_proxy_classes</span><span style="--0:#89DDFF">:</span><span style="--0:#BABED8"> </span><span style="--0:#89DDFF">'</span><span style="--0:#C3E88D">%kernel.debug%</span><span style="--0:#89DDFF">'</span></div><div class="ec-line"><span style="--0:#BABED8">    </span><span style="--0:#F2858B">naming_strategy</span><span style="--0:#89DDFF">:</span><span style="--0:#BABED8"> </span><span style="--0:#C3E88D">doctrine.orm.naming_strategy.underscore</span></div><div class="ec-line"><span style="--0:#89DDFF">    </span><span style="--0:#9FA4BC;--0fs:italic"># IMPORTANT!</span></div><div class="ec-line"><span style="--0:#BABED8">    </span><span style="--0:#F2858B">auto_mapping</span><span style="--0:#89DDFF">:</span><span style="--0:#BABED8"> </span><span style="--0:#FF9CAC">true</span></div><div class="ec-line"><span style="--0:#BABED8">    </span><span style="--0:#F2858B">metadata_cache_driver</span><span style="--0:#89DDFF">:</span><span style="--0:#BABED8"> </span><span style="--0:#C3E88D">redis</span></div><div class="ec-line"><span style="--0:#BABED8">    </span><span style="--0:#F2858B">query_cache_driver</span><span style="--0:#89DDFF">:</span><span style="--0:#BABED8"> </span><span style="--0:#C3E88D">redis</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#9FA4BC;--0fs:italic"># redis.yml</span></div><div class="ec-line"><span style="--0:#F2858B">snc_redis</span><span style="--0:#89DDFF">:</span></div><div class="ec-line"><span style="--0:#BABED8">  </span><span style="--0:#F2858B">clients</span><span style="--0:#89DDFF">:</span></div><div class="ec-line"><span style="--0:#BABED8">    </span><span style="--0:#F2858B">default</span><span style="--0:#89DDFF">:</span></div><div class="ec-line"><span style="--0:#BABED8">      </span><span style="--0:#F2858B">type</span><span style="--0:#89DDFF">:</span><span style="--0:#BABED8"> </span><span style="--0:#C3E88D">predis</span></div><div class="ec-line"><span style="--0:#BABED8">      </span><span style="--0:#F2858B">alias</span><span style="--0:#89DDFF">:</span><span style="--0:#BABED8"> </span><span style="--0:#C3E88D">default</span></div><div class="ec-line"><span style="--0:#BABED8">      </span><span style="--0:#F2858B">dsn</span><span style="--0:#89DDFF">:</span><span style="--0:#BABED8"> </span><span style="--0:#C3E88D">redis://1.2.3.4</span></div><div class="ec-line"><span style="--0:#BABED8">    </span><span style="--0:#F2858B">doctrine</span><span style="--0:#89DDFF">:</span></div><div class="ec-line"><span style="--0:#BABED8">      </span><span style="--0:#F2858B">type</span><span style="--0:#89DDFF">:</span><span style="--0:#BABED8"> </span><span style="--0:#C3E88D">predis</span></div><div class="ec-line"><span style="--0:#BABED8">      </span><span style="--0:#F2858B">alias</span><span style="--0:#89DDFF">:</span><span style="--0:#BABED8"> </span><span style="--0:#C3E88D">doctrine</span></div><div class="ec-line"><span style="--0:#BABED8">      </span><span style="--0:#F2858B">dsn</span><span style="--0:#89DDFF">:</span><span style="--0:#BABED8"> </span><span style="--0:#C3E88D">redis://1.2.3.4</span></div><div class="ec-line"><span style="--0:#BABED8">  </span><span style="--0:#F2858B">doctrine</span><span style="--0:#89DDFF">:</span></div><div class="ec-line"><span style="--0:#BABED8">    </span><span style="--0:#F2858B">metadata_cache</span><span style="--0:#89DDFF">:</span></div><div class="ec-line"><span style="--0:#BABED8">      </span><span style="--0:#F2858B">client</span><span style="--0:#89DDFF">:</span><span style="--0:#BABED8"> </span><span style="--0:#C3E88D">doctrine</span></div><div class="ec-line"><span style="--0:#BABED8">      </span><span style="--0:#F2858B">entity_manager</span><span style="--0:#89DDFF">:</span><span style="--0:#BABED8"> </span><span style="--0:#C3E88D">default</span></div><div class="ec-line"><span style="--0:#BABED8">      </span><span style="--0:#F2858B">document_manager</span><span style="--0:#89DDFF">:</span><span style="--0:#BABED8"> </span><span style="--0:#C3E88D">default</span></div><div class="ec-line"><span style="--0:#BABED8">    </span><span style="--0:#F2858B">result_cache</span><span style="--0:#89DDFF">:</span></div><div class="ec-line"><span style="--0:#BABED8">      </span><span style="--0:#F2858B">client</span><span style="--0:#89DDFF">:</span><span style="--0:#BABED8"> </span><span style="--0:#C3E88D">doctrine</span></div><div class="ec-line"><span style="--0:#BABED8">      </span><span style="--0:#F2858B">entity_manager</span><span style="--0:#89DDFF">:</span><span style="--0:#BABED8"> </span><span style="--0:#C3E88D">default</span></div><div class="ec-line"><span style="--0:#BABED8">    </span><span style="--0:#F2858B">query_cache</span><span style="--0:#89DDFF">:</span></div><div class="ec-line"><span style="--0:#BABED8">      </span><span style="--0:#F2858B">client</span><span style="--0:#89DDFF">:</span><span style="--0:#BABED8"> </span><span style="--0:#C3E88D">doctrine</span></div><div class="ec-line"><span style="--0:#BABED8">      </span><span style="--0:#F2858B">entity_manager</span><span style="--0:#89DDFF">:</span><span style="--0:#BABED8"> </span><span style="--0:#C3E88D">default</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="imports:  - { resource: redis.yml }# Doctrine Configurationdoctrine:  dbal:    #...  orm:    auto_generate_proxy_classes: &#x27;%kernel.debug%&#x27;    naming_strategy: doctrine.orm.naming_strategy.underscore    # IMPORTANT!    auto_mapping: true    metadata_cache_driver: redis    query_cache_driver: redis# redis.ymlsnc_redis:  clients:    default:      type: predis      alias: default      dsn: redis://1.2.3.4    doctrine:      type: predis      alias: doctrine      dsn: redis://1.2.3.4  doctrine:    metadata_cache:      client: doctrine      entity_manager: default      document_manager: default    result_cache:      client: doctrine      entity_manager: default    query_cache:      client: doctrine      entity_manager: default"><div></div></button></div></figure></div>
<p>Et voilà pour l’installation.<br>
A ce stade, seuls les caches de metadata et de query sont opérationnels. Pour la mise en cache du
résultat, il faudra le faire <strong>manuellement sur chaque requête</strong>.</p>
<h2 id="mettre-en-cache-le-résultat">Mettre en cache le résultat</h2>
<p>Terminé les requêtes <em>inlines</em> dans les controllers ! Vous allez désormais devoir utiliser le
<abbr title="Doctrine Query Language">DQL</abbr> ou le QueryBuilder.</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#89DDFF">&#x3C;?</span><span style="--0:#BABED8">php</span></div><div class="ec-line"><span style="--0:#C792EA">public</span><span style="--0:#BABED8"> </span><span style="--0:#C792EA">function</span><span style="--0:#BABED8"> </span><span style="--0:#82AAFF">findBeers</span><span style="--0:#89DDFF">()</span></div><div class="ec-line"><span style="--0:#89DDFF">{</span></div><div class="ec-line"><span style="--0:#BABED8">    </span><span style="--0:#89DDFF">$</span><span style="--0:#BABED8">query </span><span style="--0:#89DDFF">=</span><span style="--0:#BABED8"> </span><span style="--0:#89DDFF">$this-></span><span style="--0:#82AAFF">getEntityManager</span><span style="--0:#89DDFF">()</span></div><div class="ec-line"><span style="--0:#BABED8">        </span><span style="--0:#89DDFF">-></span><span style="--0:#82AAFF">createQuery</span><span style="--0:#89DDFF">(</span></div><div class="ec-line"><span style="--0:#BABED8">            </span><span style="--0:#89DDFF">'</span><span style="--0:#C3E88D">select beers from MaxpouBeerBundle:Beers b</span><span style="--0:#89DDFF">'</span></div><div class="ec-line"><span style="--0:#BABED8">        </span><span style="--0:#89DDFF">)</span></div><div class="ec-line"><span style="--0:#BABED8">    </span><span style="--0:#89DDFF">;</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#BABED8">    </span><span style="--0:#89DDFF">$</span><span style="--0:#BABED8">query</span><span style="--0:#89DDFF">-></span><span style="--0:#82AAFF">useResultCache</span><span style="--0:#89DDFF">(true);</span></div><div class="ec-line"><span style="--0:#BABED8">    </span><span style="--0:#89DDFF">$</span><span style="--0:#BABED8">query</span><span style="--0:#89DDFF">-></span><span style="--0:#82AAFF">setResultCacheLifetime</span><span style="--0:#89DDFF">(</span><span style="--0:#F78C6C">3600</span><span style="--0:#89DDFF">);</span><span style="--0:#BABED8"> </span><span style="--0:#9FA4BC;--0fs:italic">//3600sec = 1 hour</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#BABED8">    </span><span style="--0:#89DDFF;--0fs:italic">return</span><span style="--0:#BABED8"> </span><span style="--0:#89DDFF">$</span><span style="--0:#BABED8">query</span><span style="--0:#89DDFF">-></span><span style="--0:#82AAFF">getResult</span><span style="--0:#89DDFF">();</span></div><div class="ec-line"><span style="--0:#89DDFF">}</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="<?phppublic function findBeers(){    $query = $this->getEntityManager()        ->createQuery(            &#x27;select beers from MaxpouBeerBundle:Beers b&#x27;        )    ;    $query->useResultCache(true);    $query->setResultCacheLifetime(3600); //3600sec = 1 hour    return $query->getResult();}"><div></div></button></div></figure></div>
<p>Maintenant, si l’on recharge la page, cette requête ne se fera plus via MySQL mais bien via Redis.
On peut vérifier tout cela en allant sur Redis et en rentrant la commande suivante : <code>KEYS *</code>. Voici
ce que l’on va avoir :</p>
<div class="expressive-code"><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#89DDFF">></span><span style="--0:#BABED8"> KEYS </span><span style="--0:#89DDFF">*</span></div><div class="ec-line"><span style="--0:#FFCB6B">1</span><span style="--0:#BABED8">) </span><span style="--0:#89DDFF">"</span><span style="--0:#C3E88D">[Maxpou</span><span style="--0:#BABED8">\\</span><span style="--0:#C3E88D">BeerBundle</span><span style="--0:#BABED8">\\</span><span style="--0:#C3E88D">Entity</span><span style="--0:#BABED8">\\</span><span style="--0:#C3E88D">Beer</span><span style="--0:#BABED8">$CLASSMETADATA</span><span style="--0:#C3E88D">][1]</span><span style="--0:#89DDFF">"</span></div><div class="ec-line"><span style="--0:#FFCB6B">2</span><span style="--0:#BABED8">) </span><span style="--0:#89DDFF">"</span><span style="--0:#C3E88D">[809cd863587594a754a7ffda5c2c06ee4640ebe3][1]</span><span style="--0:#89DDFF">"</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="> KEYS *1) &#x22;[Maxpou\\BeerBundle\\Entity\\Beer$CLASSMETADATA][1]&#x22;2) &#x22;[809cd863587594a754a7ffda5c2c06ee4640ebe3][1]&#x22;"><div></div></button></div></figure></div>
<p>La première ligne va contenir les métadonnées de la classe Beer. La seconde, contiendra la requête
<strong>et</strong> son résultat. Si vous voulez avoir une clé un peu plus digeste, vous pouvez utiliser cette
méthode <code>$query->setResultCacheId('my_wonderful_key');</code> ou même faire <strong>1 pierre 3 coups</strong> :
<code>$query->useResultCache(true, 3600, 'my_wonderful_key');</code>.</p>
<p>Voici ce que nous aurons : (je n’ai pas réussi à supprimer le <code>[1]</code>)</p>
<div class="expressive-code"><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#89DDFF">></span><span style="--0:#BABED8"> KEYS </span><span style="--0:#89DDFF">*</span></div><div class="ec-line"><span style="--0:#FFCB6B">1</span><span style="--0:#BABED8">) </span><span style="--0:#89DDFF">"</span><span style="--0:#C3E88D">[Maxpou</span><span style="--0:#BABED8">\\</span><span style="--0:#C3E88D">BeerBundle</span><span style="--0:#BABED8">\\</span><span style="--0:#C3E88D">Entity</span><span style="--0:#BABED8">\\</span><span style="--0:#C3E88D">Beer</span><span style="--0:#BABED8">$CLASSMETADATA</span><span style="--0:#C3E88D">][1]</span><span style="--0:#89DDFF">"</span></div><div class="ec-line"><span style="--0:#FFCB6B">2</span><span style="--0:#BABED8">) </span><span style="--0:#89DDFF">"</span><span style="--0:#C3E88D">[my_wonderful_key][1]</span><span style="--0:#89DDFF">"</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="> KEYS *1) &#x22;[Maxpou\\BeerBundle\\Entity\\Beer$CLASSMETADATA][1]&#x22;2) &#x22;[my_wonderful_key][1]&#x22;"><div></div></button></div></figure></div>
<p>Pour nettoyer le cache, voici quelques commandes :</p>
<div class="expressive-code"><figure class="frame is-terminal"><figcaption class="header"><span class="title"></span><span class="sr-only">Terminal window</span></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#9FA4BC;--0fs:italic"># Nettoyer cache des queries</span></div><div class="ec-line"><span style="--0:#FFCB6B">php</span><span style="--0:#BABED8"> </span><span style="--0:#C3E88D">app/console</span><span style="--0:#BABED8"> </span><span style="--0:#C3E88D">doctrine:cache:clear-query</span></div><div class="ec-line"><span style="--0:#9FA4BC;--0fs:italic"># Nettoyer cache des metadatas</span></div><div class="ec-line"><span style="--0:#FFCB6B">php</span><span style="--0:#BABED8"> </span><span style="--0:#C3E88D">app/console</span><span style="--0:#BABED8"> </span><span style="--0:#C3E88D">doctrine:cache:clear-metadata</span></div><div class="ec-line"><span style="--0:#9FA4BC;--0fs:italic"># Nettoyer cache des résultats</span></div><div class="ec-line"><span style="--0:#FFCB6B">php</span><span style="--0:#BABED8"> </span><span style="--0:#C3E88D">app/console</span><span style="--0:#BABED8"> </span><span style="--0:#C3E88D">doctrine:cache:clear-result</span></div><div class="ec-line"><span style="--0:#9FA4BC;--0fs:italic"># Vider la base redis</span></div><div class="ec-line"><span style="--0:#FFCB6B">php</span><span style="--0:#BABED8"> </span><span style="--0:#C3E88D">app/console</span><span style="--0:#BABED8"> </span><span style="--0:#C3E88D">redis:flushdb</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="php app/console doctrine:cache:clear-queryphp app/console doctrine:cache:clear-metadataphp app/console doctrine:cache:clear-resultphp app/console redis:flushdb"><div></div></button></div></figure></div>
<h2 id="invalider-le-cache-des-requêtes">Invalider le cache des requêtes</h2>
<p>C’est bien de mettre en place un système de cache, mais vous n’allez pas demander à vos utilisateurs
de lancer la commande après chaque opération. Il va donc falloir utiliser les événements de
Doctrine, et plus particulièrement
l’<a href="http://doctrine-orm.readthedocs.org/projects/doctrine-orm/en/latest/reference/events.html#entity-listeners">entity listeners</a>
Si vous faites des tests, pensez à commenter le cache des métadonnées ;-)</p>
<p>Définissez le service :</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#89DDFF">&#x3C;?</span><span style="--0:#BABED8">php</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#F78C6C">namespace</span><span style="--0:#BABED8"> </span><span style="--0:#FFCB6B">Maxpou</span><span style="--0:#89DDFF">\</span><span style="--0:#FFCB6B">BeerBundle</span><span style="--0:#89DDFF">\</span><span style="--0:#FFCB6B">Service</span><span style="--0:#89DDFF">;</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#F78C6C">use</span><span style="--0:#FFCB6B"> </span><span style="--0:#BABED8">Doctrine</span><span style="--0:#89DDFF">\</span><span style="--0:#BABED8">ORM</span><span style="--0:#89DDFF">\</span><span style="--0:#BABED8">Event</span><span style="--0:#89DDFF">\</span><span style="--0:#BABED8">LifecycleEventArgs</span><span style="--0:#89DDFF">;</span></div><div class="ec-line"><span style="--0:#F78C6C">use</span><span style="--0:#FFCB6B"> </span><span style="--0:#BABED8">Maxpou</span><span style="--0:#89DDFF">\</span><span style="--0:#BABED8">BeerBundle</span><span style="--0:#89DDFF">\</span><span style="--0:#BABED8">Entity</span><span style="--0:#89DDFF">\</span><span style="--0:#BABED8">Beer</span><span style="--0:#89DDFF">;</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#C792EA">class</span><span style="--0:#BABED8"> </span><span style="--0:#FFCB6B">BeerListener</span></div><div class="ec-line"><span style="--0:#89DDFF">{</span></div><div class="ec-line"><span style="--0:#BABED8">    </span><span style="--0:#C792EA">private</span><span style="--0:#BABED8"> </span><span style="--0:#89DDFF">$</span><span style="--0:#BABED8">cacheDriver</span><span style="--0:#89DDFF">;</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#BABED8">    </span><span style="--0:#C792EA">public</span><span style="--0:#BABED8"> </span><span style="--0:#C792EA">function</span><span style="--0:#BABED8"> </span><span style="--0:#82AAFF">__construct</span><span style="--0:#89DDFF">($</span><span style="--0:#BABED8">cacheDriver</span><span style="--0:#89DDFF">)</span></div><div class="ec-line"><span style="--0:#BABED8">    </span><span style="--0:#89DDFF">{</span></div><div class="ec-line"><span style="--0:#BABED8">        </span><span style="--0:#89DDFF">$this-></span><span style="--0:#BABED8">cacheDriver </span><span style="--0:#89DDFF">=</span><span style="--0:#BABED8"> </span><span style="--0:#89DDFF">$</span><span style="--0:#BABED8">cacheDriver</span><span style="--0:#89DDFF">;</span></div><div class="ec-line"><span style="--0:#BABED8">    </span><span style="--0:#89DDFF">}</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#BABED8">    </span><span style="--0:#C792EA">public</span><span style="--0:#BABED8"> </span><span style="--0:#C792EA">function</span><span style="--0:#BABED8"> </span><span style="--0:#82AAFF">postPersist</span><span style="--0:#89DDFF">(</span><span style="--0:#FFCB6B">Beer</span><span style="--0:#BABED8"> </span><span style="--0:#89DDFF">$</span><span style="--0:#BABED8">beer</span><span style="--0:#89DDFF">,</span><span style="--0:#BABED8"> </span><span style="--0:#FFCB6B">LifecycleEventArgs</span><span style="--0:#BABED8"> </span><span style="--0:#89DDFF">$</span><span style="--0:#BABED8">args</span><span style="--0:#89DDFF">)</span></div><div class="ec-line"><span style="--0:#BABED8">    </span><span style="--0:#89DDFF">{</span></div><div class="ec-line"><span style="--0:#BABED8">        </span><span style="--0:#89DDFF">$this-></span><span style="--0:#BABED8">cacheDriver</span><span style="--0:#89DDFF">-></span><span style="--0:#82AAFF">expire</span><span style="--0:#89DDFF">(</span><span style="--0:#89DDFF">'</span><span style="--0:#C3E88D">[beers_all][1]</span><span style="--0:#89DDFF">'</span><span style="--0:#89DDFF">,</span><span style="--0:#BABED8"> </span><span style="--0:#F78C6C">0</span><span style="--0:#89DDFF">);</span></div><div class="ec-line"><span style="--0:#BABED8">    </span><span style="--0:#89DDFF">}</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#BABED8">    </span><span style="--0:#C792EA">public</span><span style="--0:#BABED8"> </span><span style="--0:#C792EA">function</span><span style="--0:#BABED8"> </span><span style="--0:#82AAFF">postUpdate</span><span style="--0:#89DDFF">(</span><span style="--0:#FFCB6B">Beer</span><span style="--0:#BABED8"> </span><span style="--0:#89DDFF">$</span><span style="--0:#BABED8">beer</span><span style="--0:#89DDFF">,</span><span style="--0:#BABED8"> </span><span style="--0:#FFCB6B">LifecycleEventArgs</span><span style="--0:#BABED8"> </span><span style="--0:#89DDFF">$</span><span style="--0:#BABED8">args</span><span style="--0:#89DDFF">)</span></div><div class="ec-line"><span style="--0:#BABED8">    </span><span style="--0:#89DDFF">{</span></div><div class="ec-line"><span style="--0:#BABED8">        </span><span style="--0:#89DDFF">$this-></span><span style="--0:#BABED8">cacheDriver</span><span style="--0:#89DDFF">-></span><span style="--0:#82AAFF">expire</span><span style="--0:#89DDFF">(</span><span style="--0:#89DDFF">'</span><span style="--0:#C3E88D">[beers_all][1]</span><span style="--0:#89DDFF">'</span><span style="--0:#89DDFF">,</span><span style="--0:#BABED8"> </span><span style="--0:#F78C6C">0</span><span style="--0:#89DDFF">);</span></div><div class="ec-line"><span style="--0:#BABED8">    </span><span style="--0:#89DDFF">}</span></div><div class="ec-line">
</div><div class="ec-line"><span style="--0:#BABED8">    </span><span style="--0:#C792EA">public</span><span style="--0:#BABED8"> </span><span style="--0:#C792EA">function</span><span style="--0:#BABED8"> </span><span style="--0:#82AAFF">postRemove</span><span style="--0:#89DDFF">(</span><span style="--0:#FFCB6B">Beer</span><span style="--0:#BABED8"> </span><span style="--0:#89DDFF">$</span><span style="--0:#BABED8">beer</span><span style="--0:#89DDFF">,</span><span style="--0:#BABED8"> </span><span style="--0:#FFCB6B">LifecycleEventArgs</span><span style="--0:#BABED8"> </span><span style="--0:#89DDFF">$</span><span style="--0:#BABED8">args</span><span style="--0:#89DDFF">)</span></div><div class="ec-line"><span style="--0:#BABED8">    </span><span style="--0:#89DDFF">{</span></div><div class="ec-line"><span style="--0:#BABED8">        </span><span style="--0:#89DDFF">$this-></span><span style="--0:#BABED8">cacheDriver</span><span style="--0:#89DDFF">-></span><span style="--0:#82AAFF">expire</span><span style="--0:#89DDFF">(</span><span style="--0:#89DDFF">'</span><span style="--0:#C3E88D">[beers_all][1]</span><span style="--0:#89DDFF">'</span><span style="--0:#89DDFF">,</span><span style="--0:#BABED8"> </span><span style="--0:#F78C6C">0</span><span style="--0:#89DDFF">);</span></div><div class="ec-line"><span style="--0:#BABED8">    </span><span style="--0:#89DDFF">}</span></div><div class="ec-line"><span style="--0:#89DDFF">}</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="<?phpnamespace Maxpou\BeerBundle\Service;use Doctrine\ORM\Event\LifecycleEventArgs;use Maxpou\BeerBundle\Entity\Beer;class BeerListener{    private $cacheDriver;    public function __construct($cacheDriver)    {        $this->cacheDriver = $cacheDriver;    }    public function postPersist(Beer $beer, LifecycleEventArgs $args)    {        $this->cacheDriver->expire(&#x27;[beers_all][1]&#x27;, 0);    }    public function postUpdate(Beer $beer, LifecycleEventArgs $args)    {        $this->cacheDriver->expire(&#x27;[beers_all][1]&#x27;, 0);    }    public function postRemove(Beer $beer, LifecycleEventArgs $args)    {        $this->cacheDriver->expire(&#x27;[beers_all][1]&#x27;, 0);    }}"><div></div></button></div></figure></div>
<p>Ici, <code>beer_all</code> est le nom de l’id assigné au cache.</p>
<p>Le service.yml :</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#F2858B">beer_listener</span><span style="--0:#89DDFF">:</span></div><div class="ec-line"><span style="--0:#BABED8">  </span><span style="--0:#F2858B">class</span><span style="--0:#89DDFF">:</span><span style="--0:#BABED8"> </span><span style="--0:#C3E88D">Maxpou\BeerBundle\Service\BeerListener</span></div><div class="ec-line"><span style="--0:#BABED8">  </span><span style="--0:#F2858B">arguments</span><span style="--0:#89DDFF">:</span></div><div class="ec-line"><span style="--0:#BABED8">    </span><span style="--0:#89DDFF">-</span><span style="--0:#BABED8"> </span><span style="--0:#89DDFF">'</span><span style="--0:#C3E88D">@snc_redis.doctrine</span><span style="--0:#89DDFF">'</span></div><div class="ec-line"><span style="--0:#BABED8">  </span><span style="--0:#F2858B">tags</span><span style="--0:#89DDFF">:</span></div><div class="ec-line"><span style="--0:#BABED8">    </span><span style="--0:#89DDFF">-</span><span style="--0:#BABED8"> </span><span style="--0:#89DDFF">{</span><span style="--0:#BABED8"> </span><span style="--0:#F2858B">name</span><span style="--0:#89DDFF">:</span><span style="--0:#BABED8"> </span><span style="--0:#C3E88D">doctrine.orm.entity_listener</span><span style="--0:#BABED8"> </span><span style="--0:#89DDFF">}</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="beer_listener:  class: Maxpou\BeerBundle\Service\BeerListener  arguments:    - &#x27;@snc_redis.doctrine&#x27;  tags:    - { name: doctrine.orm.entity_listener }"><div></div></button></div></figure></div>
<p>Et enfin l’annotation sur l’entity :</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre tabindex="0"><code><div class="ec-line"><span style="--0:#89DDFF">&#x3C;?</span><span style="--0:#BABED8">php</span></div><div class="ec-line"><span style="--0:#9FA4BC;--0fs:italic">/**</span></div><div class="ec-line"><span style="--0:#9FA4BC;--0fs:italic"> * Beer</span></div><div class="ec-line"><span style="--0:#9FA4BC;--0fs:italic"> *</span></div><div class="ec-line"><span style="--0:#9FA4BC;--0fs:italic"> * @ORM\Table(name="beers")</span></div><div class="ec-line"><span style="--0:#9FA4BC;--0fs:italic"> * @ORM\Entity(repositoryClass="Maxpou\BeerBundle\Repository\BeerRepository")</span></div><div class="ec-line"><span style="--0:#9FA4BC;--0fs:italic"> * @ORM\EntityListeners({"Maxpou\BeerBundle\Service\BeerListener"})</span></div><div class="ec-line"><span style="--0:#9FA4BC;--0fs:italic"> */</span></div><div class="ec-line"><span style="--0:#C792EA">class</span><span style="--0:#BABED8"> </span><span style="--0:#FFCB6B">Beer</span><span style="--0:#BABED8"> </span><span style="--0:#C792EA">implements</span><span style="--0:#BABED8"> </span><span style="--0:#FFCB6B">BeerInterface</span></div><div class="ec-line"><span style="--0:#89DDFF">{</span></div><div class="ec-line"><span style="--0:#9FA4BC;--0fs:italic">//...</span></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="<?php/** * Beer * * @ORM\Table(name=&#x22;beers&#x22;) * @ORM\Entity(repositoryClass=&#x22;Maxpou\BeerBundle\Repository\BeerRepository&#x22;) * @ORM\EntityListeners({&#x22;Maxpou\BeerBundle\Service\BeerListener&#x22;}) */class Beer implements BeerInterface{//..."><div></div></button></div></figure></div>
<p>Les plus pointilleux d’entre vous auront remarqués que je redéfini le TTL de ma clef au lieu de la
supprimer. En effet, si je supprime ma clef, la nouvelle clef créée sera <code>[beers_all][2]</code>. Et le
compteur augmentera ainsi de suite…<br>
Avec cette technique <s>de fainéant</s>, on garde la main sur le nom de la clef qui sera toujours
<code>[beers_all][1]</code>.</p>
<h2 id="pour-aller-plus-loin">Pour aller plus loin</h2>
<ul>
<li>Tutoriel/Sandbox Redis : <a href="http://try.redis.io">http://try.redis.io</a></li>
<li><a href="http://doctrine-orm.readthedocs.org/projects/doctrine-orm/en/latest/reference/second-level-cache.html">2e niveau de cache de Doctrine (encore à l’état expérimental)</a></li>
</ul>
<h2 id="tips">Tips</h2>
<p>Utiliser les pipes unix avec le redis-cli : <code>echo "KEYS *" | ./path/to/redis-cli | grep beer</code><br>
Vérifier le <abbr title="Time To Live">TTL</abbr> d’une clef: <code>TTL [beer-id-42][1]</code></p> <div> <hr> <h2 class="dark:text-gray-100">About the author</h2> <div class="flex flex-col md:flex-row items-center gap-5 md:gap-8 mt-5"> <div class="relative flex-shrink-0 h-32 w-32"> <img src="/_astro/profile-picture.gF0h5NUU_Zw8iDo.webp" class="not-prose h-32 w-32 object-cover rounded-full" alt="Maxence Poutord Profile picture" width="128" height="128" loading="lazy" decoding="async"> </div> <div> <p class="!mt-0 pb-2">
Hey, I'm Maxence Poutord, a passionate software engineer. In my
        day-to-day job, I'm working as a senior front-end engineer at Orderfox.
        When I'm not working, you can find me travelling the world or cooking.
</p> <a class="not-prose inline-flex rounded border
    font-semibold no-underline
    transition-colors duration-200 ease-in-out px-3 py-2
    border-[#1da1f2] bg-[#1da1f2] text-white
    hover:border-[#1da1f2] hover:bg-white hover:text-[#1da1f2]" rel="noopener" target="_blank" href="https://twitter.com/intent/follow?screen_name=_maxpou"> <svg aria-label="Twitter" viewBox="0 0 24 24" width="1em" height="1em" class="h-6 w-6 pr-2"><path fill="currentColor" d="M23.954 4.569a10 10 0 0 1-2.825.775 4.958 4.958 0 0 0 2.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 0 0-8.384 4.482C7.691 8.094 4.066 6.13 1.64 3.161a4.822 4.822 0 0 0-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 0 1-2.228-.616v.061a4.923 4.923 0 0 0 3.946 4.827 4.996 4.996 0 0 1-2.212.085 4.937 4.937 0 0 0 4.604 3.417 9.868 9.868 0 0 1-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 0 0 7.557 2.209c9.054 0 13.999-7.496 13.999-13.986 0-.209 0-.42-.015-.63a9.936 9.936 0 0 0 2.46-2.548l-.047-.02z"></path></svg>
Follow @_maxpou
 </a> </div> </div> </div>  </div>  <div> <h2 class="text-2xl underline mt-12 font-bold dark:text-mainYellow">
Recommended posts
</h2> <div class="grid grid-cols-1 gap-4 md:grid-cols-2 mt-6"> <a title="3 Tips for Scaling Large Vue.js Application" href="/blog/3-tips-scaling-vue-application/" class="ease flex flex-col rounded-lg bg-white transition duration-300 dark:bg-gray-500 hover:translate-y-0.5 shadow-md  hover:shadow-xl group"> <img src="/_astro/cover.ex1KwcGk_Z1CSi66.webp" alt="Cover picture for 3 Tips for Scaling Large Vue.js Application" class="h-56 w-full rounded-b-none rounded-t-lg object-cover transition" width="420" height="224" loading="lazy" decoding="async"> <div class="p-4"> <header class="text-xl font-semibold text-gray-700 dark:text-gray-100"> <span class="inline">  <!-- {post.data.title} --> <span class="from-blue-100 to-blue-100 text-dark dark:bg-none
           bg-gradient-to-r bg-[length:0px_10px] bg-left-bottom bg-no-repeat transition-[background-size] duration-500 hover:bg-[length:100%_3px] group-hover:bg-[length:100%_10px]"> 3 Tips for Scaling Large Vue.js Application </span> </span> </header> <p class="date text-gray-400 dark:text-gray-100"> <time datetime="2018-12-13T00:00:00.000Z"> 13 December 2018 </time> </p> </div> </a><a title="Vue.js Testing Made it Easy (with Testing Library)" href="/blog/vue-js-testing-library/" class="ease flex flex-col rounded-lg bg-white transition duration-300 dark:bg-gray-500 hover:translate-y-0.5 shadow-md  hover:shadow-xl group"> <img src="/_astro/cover.BQNQ0oHj_ZGjvpB.webp" alt="Cover picture for Vue.js Testing Made it Easy (with Testing Library)" class="h-56 w-full rounded-b-none rounded-t-lg object-cover transition" width="420" height="224" loading="lazy" decoding="async"> <div class="p-4"> <header class="text-xl font-semibold text-gray-700 dark:text-gray-100"> <span class="inline">  <!-- {post.data.title} --> <span class="from-blue-100 to-blue-100 text-dark dark:bg-none
           bg-gradient-to-r bg-[length:0px_10px] bg-left-bottom bg-no-repeat transition-[background-size] duration-500 hover:bg-[length:100%_3px] group-hover:bg-[length:100%_10px]"> Vue.js Testing Made it Easy (with Testing Library) </span> </span> </header> <p class="date text-gray-400 dark:text-gray-100"> <time datetime="2020-06-11T00:00:00.000Z"> 11 June 2020 </time> </p> </div> </a> </div> </div>  </div> </article>  </main> <footer class="bg-blue-50 dark:bg-gray-600 dark:text-white w-full mx-auto pb-0" data-astro-cid-sz7xmlte> <div class="m-auto flex w-[1024px] max-w-full flex-wrap justify-between" data-astro-cid-sz7xmlte> <div class="w-full pb-4 md:w-auto flex-auto" data-astro-cid-sz7xmlte> <p class="pb-1 font-bold" data-astro-cid-sz7xmlte>
&copy; 2014 - 2024 - Maxence Poutord </p> <p data-astro-cid-sz7xmlte>Built with Astro, Tailwind and some ☕️</p> <p data-astro-cid-sz7xmlte>
Hosted with <span class="text-red-500" data-astro-cid-sz7xmlte>❤</span> by <a class="hover:text-gray-700 hover:underline dark:hover:text-mainYellow" href="https://github.com/maxpou/maxpou.fr" data-astro-cid-sz7xmlte>GitHub</a>.
</p> </div> <div class="flex-auto" data-astro-cid-sz7xmlte> <h3 class="pb-1 font-bold" data-astro-cid-sz7xmlte>Explore</h3> <ul data-astro-cid-sz7xmlte> <li data-astro-cid-sz7xmlte> <a href="/uses" target="_self" class="hover:text-gray-700 hover:underline dark:hover:text-mainYellow" data-astro-cid-sz7xmlte> Uses </a> </li><li data-astro-cid-sz7xmlte> <a href="/recipes" target="_self" class="hover:text-gray-700 hover:underline dark:hover:text-mainYellow" data-astro-cid-sz7xmlte> Recipes (kitchen) </a> </li><li data-astro-cid-sz7xmlte> <a href="/about" target="_self" class="hover:text-gray-700 hover:underline dark:hover:text-mainYellow" data-astro-cid-sz7xmlte> About </a> </li><li data-astro-cid-sz7xmlte> <a href="/cv" target="_blank" class="hover:text-gray-700 hover:underline dark:hover:text-mainYellow" data-astro-cid-sz7xmlte> Resume (cv) </a> </li><li data-astro-cid-sz7xmlte> <a href="/readme" target="_self" class="hover:text-gray-700 hover:underline dark:hover:text-mainYellow" data-astro-cid-sz7xmlte> Readme </a> </li> </ul> </div> <div class="flex-auto" data-astro-cid-sz7xmlte> <h3 class="pb-1 font-bold flex-auto" data-astro-cid-sz7xmlte>Let's connect</h3> <ul data-astro-cid-sz7xmlte> <li data-astro-cid-sz7xmlte> <a href="https://github.com/maxpou" rel="noopener noreferrer" class="hover:text-gray-700 hover:underline dark:hover:text-mainYellow" data-astro-cid-sz7xmlte> GitHub </a> </li><li data-astro-cid-sz7xmlte> <a href="https://twitter.com/_maxpou" rel="noopener noreferrer" class="hover:text-gray-700 hover:underline dark:hover:text-mainYellow" data-astro-cid-sz7xmlte> Twitter </a> </li><li data-astro-cid-sz7xmlte> <a href="https://www.linkedin.com/in/maxpou/" rel="noopener noreferrer" class="hover:text-gray-700 hover:underline dark:hover:text-mainYellow" data-astro-cid-sz7xmlte> LinkedIn </a> </li><li data-astro-cid-sz7xmlte> <a href="/rss.xml" class="hover:text-gray-700 hover:underline dark:hover:text-mainYellow" data-astro-cid-sz7xmlte> RSS feed </a> </li> </ul> </div> </div>  </footer>  </body> </html>